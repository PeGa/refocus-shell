#!/usr/bin/env bash
# Refocus Shell - Main Dispatcher Script
# Copyright (c) 2025 PeGa
# Licensed under the GNU General Public License v3

# Exit on any error for critical safety
set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Function to get the command directory
get_command_dir() {
    # First check installed location
    if [[ -d "$HOME/.local/refocus/commands" ]]; then
        echo "$HOME/.local/refocus/commands"
    else
        # Fallback to source directory
        echo "$SCRIPT_DIR/commands"
    fi
}

# Function to execute a subcommand
execute_subcommand() {
    local subcommand="$1"
    shift
    
    local command_dir
    command_dir=$(get_command_dir)
    local command_file="$command_dir/focus-$subcommand.sh"
    
    if [[ -f "$command_file" ]]; then
        # Source the libraries first
        if [[ -f "$HOME/.local/refocus/lib/focus-db.sh" ]]; then
            source "$HOME/.local/refocus/lib/focus-db.sh"
            source "$HOME/.local/refocus/lib/focus-utils.sh"
        else
            source "$SCRIPT_DIR/lib/focus-db.sh"
            source "$SCRIPT_DIR/lib/focus-utils.sh"
        fi
        
        # Execute the subcommand
        "$command_file" "$@"
    else
        echo "❌ Unknown subcommand: $subcommand"
        echo "Run 'focus help' for available commands"
        exit 1
    fi
}

# Main command dispatch
case "${1:-}" in
    "on")
        execute_subcommand "on" "${@:2}"
        ;;
    "off")
        execute_subcommand "off" "${@:2}"
        ;;
    "status")
        execute_subcommand "status" "${@:2}"
        ;;
    "enable")
        execute_subcommand "enable" "${@:2}"
        ;;
    "disable")
        execute_subcommand "disable" "${@:2}"
        ;;
    "reset")
        execute_subcommand "reset" "${@:2}"
        ;;
    "init")
        execute_subcommand "init" "${@:2}"
        ;;
    "export")
        execute_subcommand "export" "${@:2}"
        ;;
    "import")
        execute_subcommand "import" "${@:2}"
        ;;
    "past")
        execute_subcommand "past" "${@:2}"
        ;;
    "report")
        execute_subcommand "report" "${@:2}"
        ;;
    "test-nudge")
        execute_subcommand "test-nudge" "${@:2}"
        ;;
    "config")
        execute_subcommand "config" "${@:2}"
        ;;
    "description")
        execute_subcommand "description" "${@:2}"
        ;;
    "notes")
        execute_subcommand "notes" "${@:2}"
        ;;
    "help"|"--help"|"-h"|"")
        execute_subcommand "help" "${@:2}"
        ;;
    *)
        echo "❌ Unknown command: $1"
        echo "Run 'focus help' for available commands"
        exit 1
        ;;
esac
bash -c exit && exit
